---
layout: post
title: "[HL-30] Create a scheduled (cron-like) task in AWS Fargate"
categories:
    - aws
tags:
    - AWS Fargate
    - Cron
    - Scheduled task
published: true
---

<!-- 
1. A scheduled (cron-like) task
2. AWS Fargate
3. Create a Fargate scheduled task
-->

## A scheduled (cron-like) task

This all begins with my need to schedule a script to crawl some stock data weekly.
In a web service or application, we always have some needs to do a job at at fixed
times, dates, or intervals.

The most famous job scheduler is [cron](https://en.wikipedia.org/wiki/Cron), which
provides a utility for scheduling repetitive tasks on Linux/Unix systems. 
Cron Expression is commonly used to let you define when tasks should be run. You 
can check this website [crontab.guru](https://crontab.guru/) to configure the cron 
expression. There are different variants of Cron Expression used in systems, like 
Jenkins, Kubernetes CronJob, Fargate Scheduled Task etc. Make sure you check its 
instructions before use.

## AWS Fargate

Fargate is a new managed service for container orchestration provided by AWS. In ECS, we 
always need to provision the EC2 cluster first before running services. Also, there 
is an operation cost to maintain the cluster. When there is a change, we need to 
change both the underlying cluster (the number of EC2 instances) and services 
(the number of tasks). In Fargate, you don't need to operate the cluster. You can 
image Fargate as a unlimited cluster that you can use and you pay as you use. 

Fargate also provides the ability to run scheduled tasks via CloudWatch Events. 

There are a couple of other job schedulers: 

- Kubernetes CronJob
- Airflow (using Celery scheduler)
- Jenkins

Kubernetes CronJob needs to operate a Kubernetes cluster (I haven't tried AWS EKS yet). 
Airflow needs to run a machine or a cluster and also is tied to Python. 
Jenkins can be used as a job scheduler but it is not designed for this. 

The major advantages of uisng Fargate I think are:

- No operation code and cost
- Support Docker containers
- Easy for scaling up

Plus, Fargate is an extension to ECS, which I am very familar with.

## Create a Fargate scheduled task

1. create an empty cluster and a VPC configured with two public subnets
ecs-cli up

A VPC has a default security group.

2. create log group, s3 bucket, task exec role

3. build & push docker image

4. deploy ECS task definition

5. create a scheduled Fargate task

5a. update cfn/scheduled_task_params::ScheduledWorkerTaskArn
5b. 
```
cd cfn
make deploy-cron
```
5c. add a disabled task

6. manually update the task config in CloudWatch Event Rules (cloudfomation doesen't support yet)

6a. Edit
- Launch Type: Fargate
- Platform Version: LATEST
- Subnets: subnet-001, subnet-002
- Security Group: sg-001
- Auto-assign Public IP (MUST): ENABLED
- Use existing role: TaskSchedulerRole

6b. Enable the task
