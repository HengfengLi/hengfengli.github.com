---
layout: post
title: "[HL-17] How to route tasks in Celery + RabbitMQ"
categories: 
    - development
tags: 
    - Python
    - celery
    - dead letter queue
published: true
---

Continue to my last post. How should we route tasks to different queues in Celery? 

Here is the example: 

```python
from celery import Celery
from kombu import Exchange, Queue
from celery.exceptions import Reject

default_queue_name = 'default'
default_exchange_name = 'default'
default_routing_key = 'default'

sunshine_queue_name = 'sunshine'
sunshine_routing_key = 'sunshine'

moon_queue_name = 'moon'
moon_routing_key = 'moon'

app = Celery(
    'tasks',
    broker='amqp://guest@localhost:5672//',
    backend='redis://localhost:6379/0')

default_exchange = Exchange(default_exchange_name, type='direct')
default_queue = Queue(
    default_queue_name,
    default_exchange,
    routing_key=default_routing_key)

sunshine_queue = Queue(
    sunshine_queue_name,
    default_exchange,
    routing_key=sunshine_routing_key)

moon_queue = Queue(
    moon_queue_name,
    default_exchange,
    routing_key=moon_queue_name)

app.conf.task_queues = (default_queue, sunshine_queue, moon_queue)

app.conf.task_default_queue = default_queue_name
app.conf.task_default_exchange = default_exchange_name
app.conf.task_default_routing_key = default_routing_key


@app.task
def add(x, y):
    return x + y
```

We can specify queue, exchange, routing_key when calling `apply_async`. However, it is very confusing that when calling `apply_async(routing_key='xxx')`, the message goes to the default queue. If you don't set `app.conf.task_default_queue`, it will create a queue with name `celery` for you. 

Actually, the trick is to specify either `queue` or `exchange + routing_key`. I tried the following examples: 

```bash
add.apply_async((1,2)) => default_queue

add.apply_async((1,2), routing_key='moon')
=> default_queue

add.apply_async((1,2), routing_key='sunshine')
=> default_queue

add.apply_async((1,2), exchange='default', routing_key='moon') 
=> moon_queue

add.apply_async((1,2), exchange='default', routing_key='sunshine') 
=> sunshine_queue

add.apply_async((1,2), queue='sunshine') 
=> sunshine_queue

add.apply_async((1,2), queue='moon') 
=> moon_queue
```

So there are two options to route tasks to specific queues in celery: 
* queue
* exchange + routing_key
